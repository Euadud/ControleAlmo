<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Peças - Neon</title>
<style>

  /* Reset básico */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f0f2f5;
    color: #333;
  }

  /* Containers */
  #loginContainer, #mainContainer {
    max-width: 700px;
    margin: 50px auto;
    padding: 30px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  h1, h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
  }

  /* Inputs e Botões */
  input {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52,152,219,0.5);
  }

  button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border: none;
    border-radius: 8px;
    background-color: #3498db;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
  }

  button:hover {
    background-color: #2980b9;
  }

  /* Tabela */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
    background-color: #fff;
  }

  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
    background-color: #3498db;
    color: #fff;
  }

  tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  td input[type=number] {
    width: 80px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  td button {
    width: auto;
    padding: 6px 12px;
    background-color: #e74c3c;
    font-size: 14px;
  }

  td button:hover {
    background-color: #c0392b;
  }

  /* Menu usuário */
  .usuario-logado {
    margin-top: 30px;
    text-align: right;
    position: relative;
  }

  .usuario-info {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    background-color: #ecf0f1;
    padding: 8px 12px;
    border-radius: 8px;
  }

  .usuario-info img {
    border-radius: 50%;
  }

  .seta {
    font-size: 14px;
    color: #2c3e50;
  }

  .menu-usuario {
    display: none;
    position: absolute;
    right: 0;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 5px;
    width: 150px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .menu-usuario a {
    display: block;
    padding: 10px;
    color: #2c3e50;
    text-decoration: none;
    transition: 0.2s;
  }

  .menu-usuario a:hover {
    background-color: #3498db;
    color: #fff;
  }

  /* Responsivo */
  @media(max-width: 768px){
    #loginContainer, #mainContainer { margin: 20px; padding: 20px; }
    td input[type=number] { width: 60px; }
    button { font-size: 14px; }
  }
</style>

</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginContainer">
  <h2>Login - Almoxarifado</h2>
  <input type="text" id="loginUser" placeholder="Usuário"><br>
  <input type="password" id="loginPass" placeholder="Senha"><br>
  <button id="loginBtn">Entrar</button>
  <div id="errorMessage" style="color:red;margin-top:10px;"></div>
</div>

<!-- CONTEÚDO PRINCIPAL -->
<div id="mainContainer" style="display:none;">
  <h1>Controle de Peças - Neon</h1>

  <div class="config">
    <label>Nome da Peça:</label>
    <input type="text" id="nomePeca" placeholder="Ex: Parafuso"><br>

    <label>Código da Peça:</label>
    <input type="text" id="codigoPeca" placeholder="Ex: P123"><br>

    <label>Quantidade:</label>
    <input type="number" id="quantidadePeca" placeholder="Ex: 100"><br>

    <button id="addPecaBtn">Adicionar Peça</button>
    <button id="exportBtn">Exportar para Excel</button>
  </div>

  <table id="tabelaPecas">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Código</th>
        <th>Quantidade</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="usuarioLogado" class="usuario-logado">
    <div class="usuario-info" id="usuarioInfo">
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" width="32" alt="Ícone usuário">
      <span id="nomeUsuario">Usuário</span>
      <span class="seta">&#9662;</span>
    </div>
    <div id="menuUsuario" class="menu-usuario" style="display:none;">
      <a href="#" id="logoutBtn">Sair</a>
    </div>
  </div>
</div>

<script>
import { neon } from '@netlify/neon';
const sql = neon(); // automatically uses env NETLIFY_DATABASE_URL
const [post] = await sql`SELECT * FROM posts WHERE id = ${postId}`;
let listaPecas = [];
let listaPecas = [];
{ "id": 12345, "nome": "Parafuso", "codigo": "P123", "quantidade": 100 }

// ==================== LOGIN ====================
const usuarios = [
  { usuario: "admin", senha: "1234" },
  { usuario: "maria", senha: "senha123" },
  { usuario: "joao", senha: "abc321" },
  { usuario: "letticia", senha: "1337" },
];

function fazerLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  const usuarioEncontrado = usuarios.find(u => u.usuario === user && u.senha === pass);

  if(usuarioEncontrado){
    localStorage.setItem("usuarioLogado", user);
    document.getElementById('loginContainer').style.display='none';
    document.getElementById('mainContainer').style.display='block';
    document.getElementById('nomeUsuario').innerText=user;
    carregarPecas();
  } else {
    document.getElementById('errorMessage').innerText="Usuário ou senha incorretos.";
  }
}

function fazerLogout(){
  localStorage.removeItem("usuarioLogado");
  location.reload();
}

function alternarMenuUsuario(){
  const menu = document.getElementById('menuUsuario');
  menu.style.display = (menu.style.display==='none')?'block':'none';
}

// ==================== PEÇAS ====================
async function carregarPecas(){
  try {
    const res = await fetch("/.netlify/functions/listarPecas");
    if(!res.ok) throw new Error("Erro ao carregar peças");
    listaPecas = await res.json();
    atualizarTabela();
  } catch(err){
    console.error(err);
    alert("Não foi possível carregar as peças. Confira o console.");
  }
}

async function adicionarPeca(){
  const nome = document.getElementById('nomePeca').value.trim();
  const codigo = document.getElementById('codigoPeca').value.trim();
  const quantidade = parseInt(document.getElementById('quantidadePeca').value);

  if(!nome || !codigo || isNaN(quantidade)) {
    alert("Preencha todos os campos corretamente.");
    return;
  }

  try {
    const res = await fetch("/.netlify/functions/addPeca", {
      method: "POST",
      body: JSON.stringify({nome, codigo, quantidade}),
      headers: { "Content-Type": "application/json" }
    });
    
    if(!res.ok) throw new Error("Erro ao adicionar peça");

    const novaPeca = await res.json(); // espera receber {id, nome, codigo, quantidade} do banco
    listaPecas.push(novaPeca);        // adiciona na lista local
    atualizarTabela();

    document.getElementById('nomePeca').value="";
    document.getElementById('codigoPeca').value="";
    document.getElementById('quantidadePeca').value="";
  } catch(err) {
    console.error(err);
    alert("Não foi possível adicionar a peça. Confira o console.");
  }
}

async function removerPeca(id){
  try {
    const res = await fetch("/.netlify/functions/removerPeca", {
      method: "POST",
      body: JSON.stringify({id}),
      headers: { "Content-Type": "application/json" }
    });
    if(!res.ok) throw new Error("Erro ao remover peça");
    listaPecas = listaPecas.filter(p => p.id !== id);
    atualizarTabela();
  } catch(err) {
    console.error(err);
    alert("Não foi possível remover a peça. Confira o console.");
  }
}

async function editarQuantidade(id, input){
  const quantidade = parseInt(input.value);
  if(isNaN(quantidade)) return;

  try {
    const res = await fetch("/.netlify/functions/editarPeca", {
      method: "POST",
      body: JSON.stringify({id, quantidade}),
      headers: { "Content-Type": "application/json" }
    });
    if(!res.ok) throw new Error("Erro ao editar peça");
    const peca = listaPecas.find(p => p.id === id);
    if(peca) peca.quantidade = quantidade;
  } catch(err) {
    console.error(err);
    alert("Não foi possível atualizar a quantidade. Confira o console.");
  }
}

function atualizarTabela(){
  const tbody = document.getElementById('tabelaPecas').querySelector('tbody');
  tbody.innerHTML = "";

  listaPecas.forEach(peca => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${peca.nome}</td>
      <td>${peca.codigo}</td>
      <td><input type="number" value="${peca.quantidade}" min="0"></td>
      <td><button>Remover</button></td>
    `;

    const input = row.querySelector('input');
    input.addEventListener('change', () => editarQuantidade(peca.id, input));

    const btn = row.querySelector('button');
    btn.addEventListener('click', () => removerPeca(peca.id));
  });
}

// ==================== EXPORTAR ====================
function exportarParaExcel(){
  if(listaPecas.length===0){ alert("Nenhuma peça para exportar."); return;}
  let html = `<table border="1"><tr><th>Nome</th><th>Código</th><th>Quantidade</th></tr>`;
  listaPecas.forEach(p=>{
    html += `<tr><td>${p.nome}</td><td>${p.codigo}</td><td>${p.quantidade}</td></tr>`;
  });
  html += `</table>`;

  const blob = new Blob([html], {type:"application/vnd.ms-excel"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pecas.xls";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ==================== EVENTOS ====================
document.getElementById("loginBtn").addEventListener("click", fazerLogin);
document.getElementById("logoutBtn").addEventListener("click", fazerLogout);
document.getElementById("usuarioInfo").addEventListener("click", alternarMenuUsuario);
document.getElementById("addPecaBtn").addEventListener("click", adicionarPeca);
document.getElementById("exportBtn").addEventListener("click", exportarParaExcel);

// ==================== AUTOLOAD ====================
window.onload = function(){
  const user = localStorage.getItem("usuarioLogado");
  if(user){
    document.getElementById('loginContainer').style.display='none';
    document.getElementById('mainContainer').style.display='block';
    document.getElementById('nomeUsuario').innerText=user;
    carregarPecas();
  }
}
</script>
</body>

