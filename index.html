<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Peças - Neon</title>
<style>
  /* Seu CSS original mantido */
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginContainer">
  <h2>Login - Almoxarifado</h2>
  <input type="text" id="loginUser" placeholder="Usuário"><br>
  <input type="password" id="loginPass" placeholder="Senha"><br>
  <button id="loginBtn">Entrar</button>
  <div id="errorMessage" style="color:red;margin-top:10px;"></div>
</div>

<!-- CONTEÚDO PRINCIPAL -->
<div id="mainContainer" style="display:none;">
  <h1>Controle de Peças - Neon</h1>

  <div class="config">
    <label>Nome da Peça:</label>
    <input type="text" id="nomePeca"><br>

    <label>Código da Peça:</label>
    <input type="text" id="codigoPeca"><br>

    <label>Quantidade:</label>
    <input type="number" id="quantidadePeca"><br>

    <button id="addPecaBtn">Adicionar Peça</button>
    <button id="exportBtn">Exportar para Excel</button>
  </div>

  <table id="tabelaPecas">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Código</th>
        <th>Quantidade</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="usuarioLogado" class="usuario-logado">
    <div class="usuario-info" id="usuarioInfo">
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" width="32">
      <span id="nomeUsuario">Usuário</span>
      <span class="seta">&#9662;</span>
    </div>
    <div id="menuUsuario" class="menu-usuario" style="display:none;">
      <a href="#" id="logoutBtn">Sair</a>
    </div>
  </div>
</div>

<script>
let listaPecas = [];

// ==================== LOGIN ====================
const usuarios = [
  { usuario: "admin", senha: "1234" },
  { usuario: "maria", senha: "senha123" },
  { usuario: "joao", senha: "abc321" },
  { usuario: "letticia", senha: "1337" },
];

function fazerLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  const usuarioEncontrado = usuarios.find(u => u.usuario === user && u.senha === pass);

  if(usuarioEncontrado){
    localStorage.setItem("usuarioLogado", user);
    document.getElementById('loginContainer').style.display='none';
    document.getElementById('mainContainer').style.display='block';
    document.getElementById('nomeUsuario').innerText=user;
    carregarPecas();
  } else {
    document.getElementById('errorMessage').innerText="Usuário ou senha incorretos.";
  }
}

function fazerLogout(){
  localStorage.removeItem("usuarioLogado");
  location.reload();
}

function alternarMenuUsuario(){
  const menu = document.getElementById('menuUsuario');
  menu.style.display = (menu.style.display==='none')?'block':'none';
}

// ==================== PEÇAS ====================
async function carregarPecas(){
  const res = await fetch("/.netlify/functions/listarPecas");
  listaPecas = await res.json();
  atualizarTabela();
}

async function adicionarPeca(){
  const nome = document.getElementById('nomePeca').value.trim();
  const codigo = document.getElementById('codigoPeca').value.trim();
  const quantidade = parseInt(document.getElementById('quantidadePeca').value);

  if(!nome || !codigo || isNaN(quantidade)) {
    alert("Preencha todos os campos.");
    return;
  }

  const res = await fetch("/.netlify/functions/addPeca", {
    method: "POST",
    body: JSON.stringify({nome, codigo, quantidade}),
    headers: { "Content-Type": "application/json" }
  });
  const novaPeca = await res.json();
  listaPecas.push(novaPeca);
  atualizarTabela();
}

async function removerPeca(id){
  await fetch("/.netlify/functions/removerPeca", {
    method: "POST",
    body: JSON.stringify({id}),
    headers: { "Content-Type": "application/json" }
  });
  listaPecas = listaPecas.filter(p => p.id !== id);
  atualizarTabela();
}

async function editarQuantidade(id, input){
  const quantidade = parseInt(input.value);
  if(isNaN(quantidade)) return;
  await fetch("/.netlify/functions/editarPeca", {
    method: "POST",
    body: JSON.stringify({id, quantidade}),
    headers: { "Content-Type": "application/json" }
  });
  const peca = listaPecas.find(p => p.id === id);
  if(peca) peca.quantidade = quantidade;
}

function atualizarTabela(){
  const tbody = document.querySelector("#tabelaPecas tbody");
  tbody.innerHTML = "";
  listaPecas.forEach(peca => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${peca.nome}</td>
      <td>${peca.codigo}</td>
      <td><input type="number" value="${peca.quantidade}" min="0"></td>
      <td><button>Remover</button></td>
    `;
    row.querySelector("input").addEventListener("change", e => editarQuantidade(peca.id, e.target));
    row.querySelector("button").addEventListener("click", () => removerPeca(peca.id));
  });
}

// ==================== EXPORTAR ====================
function exportarParaExcel(){
  if(listaPecas.length===0){ alert("Nenhuma peça."); return;}
  let html = `<table border="1"><tr><th>Nome</th><th>Código</th><th>Quantidade</th></tr>`;
  listaPecas.forEach(p=> html += `<tr><td>${p.nome}</td><td>${p.codigo}</td><td>${p.quantidade}</td></tr>`);
  html += `</table>`;
  const blob = new Blob([html], {type:"application/vnd.ms-excel"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pecas.xls";
  link.click();
}

// ==================== EVENTOS ====================
document.getElementById("loginBtn").addEventListener("click", fazerLogin);
document.getElementById("logoutBtn").addEventListener("click", fazerLogout);
document.getElementById("usuarioInfo").addEventListener("click", alternarMenuUsuario);
document.getElementById("addPecaBtn").addEventListener("click", adicionarPeca);
document.getElementById("exportBtn").addEventListener("click", exportarParaExcel);

// ==================== AUTOLOAD ====================
window.onload = function(){
  const user = localStorage.getItem("usuarioLogado");
  if(user){
    document.getElementById('loginContainer').style.display='none';
    document.getElementById('mainContainer').style.display='block';
    document.getElementById('nomeUsuario').innerText=user;
    carregarPecas();
  }
}
import pg from "pg";
const { Pool } = pg;

// usa a variável do Netlify
const pool = new Pool({
  connectionString: process.env.NETLIFY_DATABASE_URL,
  ssl: {
    rejectUnauthorized: false,
  },
});

export default pool;
  
fetch("/.netlify/functions/auth/login", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ email, senha })
});

</script>
</body>
</html>

